name: CI

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check TypeScript compilation
        run: npm run compile

      - name: Run ESLint (if configured)
        run: |
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ] || [ -f "eslint.config.js" ]; then
            npm run lint
          else
            echo "ESLint not configured, skipping..."
          fi
        continue-on-error: true

      - name: Check Prettier formatting (if configured)
        run: |
          if [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]; then
            npm run format:check
          else
            echo "Prettier not configured, skipping..."
          fi
        continue-on-error: true

  package:
    name: Package Extension
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Compile
        run: npm run compile

      - name: Package extension
        run: vsce package --no-yarn

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v5
        with:
          name: kubeseal-vscode-${{ github.sha }}
          path: '*.vsix'
          retention-days: 30

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level moderate

      - name: Check for known vulnerabilities
        run: |
          if command -v snyk &> /dev/null; then
            snyk test
          else
            echo "Snyk not available, skipping vulnerability scan"
          fi
        continue-on-error: true

  validate-manifest:
    name: Validate Extension Manifest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Validate package.json
        run: |
          # Check required fields
          node -e "
          const pkg = require('./package.json');
          const required = ['name', 'displayName', 'description', 'version', 'publisher', 'engines', 'categories', 'main'];
          const missing = required.filter(field => !pkg[field]);
          if (missing.length > 0) {
            console.error('Missing required fields:', missing);
            process.exit(1);
          }
          console.log('✅ All required fields present');
          "

      - name: Validate with vsce
        run: vsce package --no-yarn --no-git-tag-version

  compatibility-check:
    name: VS Code Compatibility Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check VS Code engine compatibility
        run: |
          node -e "
          const pkg = require('./package.json');
          const engine = pkg.engines?.vscode;
          if (!engine) {
            console.error('❌ No VS Code engine specified');
            process.exit(1);
          }
          console.log('✅ VS Code engine:', engine);

          // Check if using supported API
          const minVersion = engine.replace('^', '').replace('~', '');
          console.log('✅ Minimum VS Code version:', minVersion);
          "
