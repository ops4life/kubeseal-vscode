name: Dependency Update

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual updates)'
        required: false
        default: false
        type: boolean
      force_update:
        description: 'Force update even if no outdated packages'
        required: false
        default: false
        type: boolean

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        id: check-outdated
        run: |
          echo "Checking for outdated packages..."
          npm outdated --json > outdated.json || true

          if [ -s outdated.json ]; then
            echo "outdated=true" >> $GITHUB_OUTPUT
            echo "Found outdated packages:"
            npm outdated
          else
            echo "outdated=false" >> $GITHUB_OUTPUT
            echo "No outdated packages found"
          fi

      - name: Generate outdated packages report
        if: always()
        run: |
          echo "## ðŸ“¦ Outdated Packages Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f outdated.json ] && [ -s outdated.json ]; then
            echo "### Outdated Dependencies:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            npm outdated >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All packages are up to date!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update dependencies
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'minor' }}"

          echo "Updating dependencies with type: $UPDATE_TYPE"

          case $UPDATE_TYPE in
            "patch")
              echo "Updating patch versions..."
              npm update
              ;;
            "minor")
              echo "Updating minor versions..."
              npx npm-check-updates -u --target minor
              npm install
              ;;
            "major")
              echo "Updating major versions..."
              npx npm-check-updates -u
              npm install
              ;;
          esac

      - name: Verify package-lock.json
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        run: |
          echo "Verifying package-lock.json integrity..."
          npm ci --dry-run
          echo "âœ… package-lock.json is valid"

      - name: Run compilation test
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        run: |
          echo "Testing compilation..."
          npm run compile
          echo "âœ… Compilation successful"

      - name: Run linting
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        run: |
          echo "Running linting..."
          npm run lint
          echo "âœ… Linting passed"

      - name: Run formatting check
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        run: |
          echo "Checking code formatting..."
          npm run format:check
          echo "âœ… Formatting check passed"

      - name: Run security audit
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        run: |
          echo "Running security audit..."
          npm audit --audit-level=moderate || true

      - name: Generate update summary
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        run: |
          echo "## ðŸ”„ Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update Type:** ${{ github.event.inputs.update_type || 'minor' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… All checks passed:" >> $GITHUB_STEP_SUMMARY
          echo "- Package integrity verified" >> $GITHUB_STEP_SUMMARY
          echo "- Compilation successful" >> $GITHUB_STEP_SUMMARY
          echo "- Linting passed" >> $GITHUB_STEP_SUMMARY
          echo "- Formatting check passed" >> $GITHUB_STEP_SUMMARY
          echo "- Security audit completed" >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request
        if: (steps.check-outdated.outputs.outdated == 'true' || github.event.inputs.force_update == 'true') && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies (${{ github.event.inputs.update_type || 'minor' }})"
          title: "chore: update dependencies (${{ github.event.inputs.update_type || 'minor' }})"
          body: |
            ## ðŸ“¦ Dependency Updates

            This PR updates npm dependencies to their latest ${{ github.event.inputs.update_type || 'minor' }} versions.

            ### ðŸ” Changes
            - Updated dependencies to latest compatible versions
            - All automated tests pass
            - Code formatting and linting checks pass
            - Security audit completed

            ### âœ… Verification
            - [x] Package integrity verified
            - [x] Compilation successful
            - [x] Linting passed
            - [x] Formatting check passed
            - [x] Security audit completed

            ### ðŸ“‹ Generated by
            - **Workflow:** Dependency Update
            - **Trigger:** ${{ github.event_name }}
            - **Update Type:** ${{ github.event.inputs.update_type || 'minor' }}
            - **Timestamp:** ${{ github.run_number }}

            Please review the changes and merge if everything looks good.

            ---
            *This PR was automatically created by the Dependency Update workflow*
          branch: dependency-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            chore

  dry-run-check:
    if: github.event.inputs.dry_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Dry run update
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'minor' }}"

          echo "## ðŸ” Dry Run - Dependency Update Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update Type:** $UPDATE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case $UPDATE_TYPE in
            "patch")
              echo "### Patch Updates:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              npm update --dry-run >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              ;;
            "minor"|"major")
              echo "### $UPDATE_TYPE Updates:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              npx npm-check-updates --target "$UPDATE_TYPE" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
